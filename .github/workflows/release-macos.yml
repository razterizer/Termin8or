name: release macos

on:
  push:
    tags:
      - 'release-*'
      - 'v*'

jobs:
  build-macos-release:
    runs-on: macos-latest
    
    steps:
      # Step 1: Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Step 2: Fetch dependencies
      - name: Fetch dependencies
        run: |
          cd ..
          git clone https://github.com/razterizer/Core.git
      
      # Step 3: Build project
      - name: Build project
        run: |
          cd Examples
          ./build_examples.sh
        continue-on-error: false

      # Step 4: Upload build artifact
      - name: Upload macOS build artifact
        uses: actions/upload-artifact@v4
        with:
          name: termin8or_examples-macos-build
          path: Examples/bin/
          retention-days: 1

  create-macos-release:
    runs-on: ubuntu-latest
    needs: build-macos-release
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Download macOS build artifact
        uses: actions/download-artifact@v4
        with:
          name: termin8or_examples-macos-build
          path: macos-build
          
      - name: Create macOS distribution package
        run: |
          cd macos-build
          # Create a clean distribution folder
          mkdir -p termin8or_examples-${{ github.ref_name }}
          # Copy the executable and necessary files
          chmod ugo+x examples
          cp examples termin8or_examples-${{ github.ref_name }}/
          # Copy background.tx
          cp -r background.tx termin8or_examples-${{ github.ref_name }}/
          echo "Unblock instructions:" > termin8or_examples-${{ github.ref_name }}/README.txt
          echo "=====================" >> termin8or_examples-${{ github.ref_name }}/README.txt
          echo "To tell the gatekeeper that this executable is fine" >> termin8or_examples-${{ github.ref_name }}/README.txt
          echo " you can unblock the executable with" >> termin8or_examples-${{ github.ref_name }}/README.txt
          echo " the following command:" >> termin8or_examples-${{ github.ref_name }}/README.txt
          echo "   xattr -dr com.apple.quarantine examples" >> termin8or_examples-${{ github.ref_name }}/README.txt
          # Create zip archive
          zip -r termin8or_examples-${{ github.ref_name }}-macos.zip termin8or_examples-${{ github.ref_name }}/
          
      - name: Extract tag annotation as release notes
        id: notes
        run: |
          git fetch --tags --force
          TAG="${{ github.ref_name }}"
          git tag -l --format='%(contents)' "$TAG" > RELEASE_NOTES.txt
          echo "Release notes extracted from tag annotation:"
          cat RELEASE_NOTES.txt
          
      - name: Debug Show ref info
        run: |
          echo "github.ref:       ${{ github.ref }}"
          echo "github.ref_name:  ${{ github.ref_name }}"
          echo "github.event_name: ${{ github.event_name }}"
          
      - name: Upload package to release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          artifacts: macos-build/termin8or_examples-${{ github.ref_name }}-macos.zip
          allowUpdates: true
          bodyFile: RELEASE_NOTES.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

